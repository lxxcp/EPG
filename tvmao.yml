name: TV Program EPG Updater

on:
  schedule:
    - cron: '0 0,12 * * *'  # UTC时间每天0点和12点（北京时间8点和20点）
  workflow_dispatch:

jobs:
  update-epg:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: Run EPG Generator
      run: |
        python tvmao.py || echo "运行遇到错误，检查日志"
        cat tvmao.log  # 输出日志

    - name: Configure Git
      run: |
        # ✅ 使用预定义变量（以 GitHub Action 执行者身份提交）
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor@github.com }}"
        
        # 或 ✅ 使用自定义 Secrets（以指定用户身份提交）
        # git config user.name "${{ secrets.GITHUB_USER }}"
        # git config user.email "${{ secrets.GITHUB_EMAIL }}"

    - name: Commit and Push
      if: [ -s tvmao.xml ]
      run: |
        git add tvmao.xml tvmao.log
        git commit -m "EPG自动更新 $(date +'%Y-%m-%d %H:%M')"
        git push
      else:
        run: echo "XML文件为空，跳过提交"
        exit 1